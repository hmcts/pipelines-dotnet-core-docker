# Docker image
# Build a Docker image to deploy, run, or push to a container registry.
# Add steps that use Docker Compose, tag images, push to a registry, run an image, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
- master

variables:
  imageName: 'vhinfrastructure.azurecr.io/vh-docker:$(Build.BuildId)'
  azureSubscriptionEndpoint: 'Reform-CFT-VH-Dev'
  azureContainerRegistry: 'vhinfrastructure.azurecr.io'
  helmVersion: '2.12.3'

stages:
- stage: Build
  displayName: Build stage
  jobs:  
  - job: Build
    displayName: Build job
    steps:

  - task: DownloadSecureFile@1
    inputs:
        secureFile: 'vh_kube_dev_helm.key.pem'

  - task: DownloadSecureFile@1
    inputs:
        secureFile: 'vh_kube_dev_helm.cert.pem'

  - task: DownloadSecureFile@1
    inputs:
        secureFile: 'vh_kube_dev_ca.cert.pem'

  - task: Docker@2
    displayName: buildAndPush
    inputs:
        containerRegistry: 'vh-acr-dev'
        repository: 'hmcts/vh-dotnet-core-docker '
        Dockerfile: Dockerfile
        tags: |
            $(Build.BuildId)
            latest
